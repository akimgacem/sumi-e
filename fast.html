<!DOCTYPE html>
<html>
  <head>
  </head>

  <body>
    <canvas width="512" height="512">
    </canvas>

    <script>
      "use strict"

      /* FIXME: Error handling! */
      function loadNoise(uri, callback) {
        var img = new Image()
        img.onload = function() {
          var canvas = document.createElement("CANVAS")
          canvas.width = img.width
          canvas.height = img.height

          var ctx = canvas.getContext("2d")
          ctx.drawImage(img, 0, 0)

          var src = ctx.getImageData(0, 0, img.width, img.height).data,
              i   = img.width * img.height,
              dst = new Uint8Array(i)

          while(i--)
            dst[i] = src[i * 4]

          return callback(undefined, dst)
        }
        img.src = uri
      }

      function catmullrom(a, b, c, d) {
        var p = -0.5 * a + 1.5 * b - 1.5 * c + 0.5 * d,
            q =        a - 2.5 * b + 2.0 * c - 0.5 * d,
            r = -0.5 * a           + 0.5 * c          ,
            s =                  b

        return function(x) {
          return ((p * x + q) * x + r) * x + s
        }
      }

      function length(x, y) {
        function segment(a, ax, ay, b, bx, by) {
          var dx = bx - ax,
              dy = by - ay,
              d  = dx * dx + dy * dy

          if(d <= 1)
            return Math.sqrt(d)

          d  = a + (b - a) * 0.5
          dx = x(d)
          dy = y(d)

          return segment(a, ax, ay, d, dx, dy) + segment(d, dx, dy, b, bx, by)
        }

        return segment(0, x(0), y(0), 1, x(1), y(1))
      }

      loadNoise("fbm.png", function(err, noise) {
        if(err)
          throw err

        var canvas = document.getElementsByTagName("CANVAS")[0],
            width  = canvas.width,
            height = canvas.height,
            ctx    = canvas.getContext("2d"),
            id     = ctx.getImageData(0, 0, width, height),
            pixels = new Int32Array(id.data.buffer)

        function lookup(x, y, z) {
          x &= 63
          y &= 63
          z &= 63
          return noise[(z * 64 + y) * 64 + x]
        }

        function spot(x, y, z, radius) {
          var xmin = x - radius
          if(xmin >= width) return

          var ymin = y - radius
          if(ymin >= height) return

          var xmax = x + radius + 1
          if(xmax <= 0) return

          var ymax = y + radius + 1
          if(ymax <= 0) return

          if(xmin < 0) xmin = 0
          else xmin = Math.floor(xmin)

          if(ymin < 0) ymin = 0
          else ymin = Math.floor(ymin)

          if(xmax > width) xmax = width
          else xmax = Math.floor(xmax)

          if(ymax > height) ymax = height
          else ymax = Math.floor(ymax)

          x      -= xmin
          y      -= ymin
          xmax   -= xmin
          ymax   -= ymin
          radius *= radius

          var i     = (ymin + ymax - 1) * width + (xmin + xmax - 1),
              skip  = width - xmax,
              v, u, dv, du, sq

          for(v = ymax; v--; i -= skip) {
            dv = v - y
            for(u = xmax; u--; --i) {
              if(pixels[i])
                continue

              du = u - x
              sq = du * du + dv * dv
              if(sq > radius)
                continue

              if(lookup(du, dv, z) > 255 * sq / radius)
                pixels[i] = 0xFF0000FF
            }
          }
        }

        function stroke(z, viscosity, spline) {
          var i  = spline.length,
              cw = spline[--i],
              cy = spline[--i],
              cx = spline[--i],
              bw = spline[--i],
              by = spline[--i],
              bx = spline[--i],
              aw = spline[--i],
              ay = spline[--i],
              ax = spline[--i],
              dw, dy, dx, ws, ys, xs, m, n, s, j, k

          spot(bx, by, z, bw)

          while(i) {
            dw = cw
            dy = cy
            dx = cx

            cw = bw
            cy = by
            cx = bx

            bw = aw
            by = ay
            bx = ax

            aw = spline[--i]
            ay = spline[--i]
            ax = spline[--i]

            ws = catmullrom(aw, bw, cw, dw)
            ys = catmullrom(ay, by, cy, dy)
            xs = catmullrom(ax, bx, cx, dx)

            m  = length(xs, ys)
            n  = Math.floor(m)
            s  = 1 / n
            m  = viscosity * m * s

            for(j = n; j--; z += m) {
              k = j * s
              spot(xs(k), ys(k), z, ws(k))
            }
          }
        }

        var x = canvas.width  * 0.5,
            y = canvas.height * 0.5,
            r = 128,
            t = Math.PI * 0.125,
            b = 48

        stroke(Date.now(), 0.125, [
          x + Math.cos(t * -1) * r, y - Math.sin(t * -1) * r, 0.000 * b,
          x + Math.cos(t *  0) * r, y - Math.sin(t *  0) * r, 0.700 * b,
          x + Math.cos(t *  1) * r, y - Math.sin(t *  1) * r, 0.681 * b,
          x + Math.cos(t *  2) * r, y - Math.sin(t *  2) * r, 0.663 * b,
          x + Math.cos(t *  3) * r, y - Math.sin(t *  3) * r, 0.644 * b,
          x + Math.cos(t *  4) * r, y - Math.sin(t *  4) * r, 0.625 * b,
          x + Math.cos(t *  5) * r, y - Math.sin(t *  5) * r, 0.606 * b,
          x + Math.cos(t *  6) * r, y - Math.sin(t *  6) * r, 0.588 * b,
          x + Math.cos(t *  7) * r, y - Math.sin(t *  7) * r, 0.569 * b,
          x + Math.cos(t *  8) * r, y - Math.sin(t *  8) * r, 0.550 * b,
          x + Math.cos(t *  9) * r, y - Math.sin(t *  9) * r, 0.531 * b,
          x + Math.cos(t * 10) * r, y - Math.sin(t * 10) * r, 0.513 * b,
          x + Math.cos(t * 11) * r, y - Math.sin(t * 11) * r, 0.494 * b,
          x + Math.cos(t * 12) * r, y - Math.sin(t * 12) * r, 0.475 * b,
          x + Math.cos(t * 13) * r, y - Math.sin(t * 13) * r, 0.456 * b,
          x + Math.cos(t * 14) * r, y - Math.sin(t * 14) * r, 0.438 * b,
          x + Math.cos(t * 15) * r, y - Math.sin(t * 15) * r, 0.419 * b,
          x + Math.cos(t * 16) * r, y - Math.sin(t * 16) * r, 0.400 * b,
          x + Math.cos(t * 17) * r, y - Math.sin(t * 17) * r, 0.000 * b
        ])

        ctx.putImageData(id, 0, 0)
      })
    </script>
  </body>
</html>
